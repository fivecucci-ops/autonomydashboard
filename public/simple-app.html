<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alyssa's Dashboard - Simple</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .card h3 { margin: 0 0 10px 0; color: #2c3e50; }
        .card .number { font-size: 2em; font-weight: bold; color: #3498db; margin: 10px 0; }
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .data-table th { background: #34495e; color: white; font-weight: bold; }
        .data-table tr:hover { background: #f8f9fa; }
        .error { color: #e74c3c; background: #fdf2f2; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .success { color: #27ae60; background: #eafaf1; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Alyssa's Dashboard</h1>
        <p>Local Mode - Dashboard Clone.xlsx</p>
    </div>
    
    <div class="container">
        <div id="status"></div>
        <div id="dashboard-cards"></div>
        <div id="patient-table"></div>
    </div>

    <script>
        // Load data when page loads
        window.addEventListener('load', loadDashboard);

        async function loadDashboard() {
            const status = document.getElementById('status');
            const cardsDiv = document.getElementById('dashboard-cards');
            const tableDiv = document.getElementById('patient-table');
            
            try {
                status.innerHTML = '<div class="loading">Loading dashboard data...</div>';
                
                // Fetch data from server
                const response = await fetch('/api/read-active?spreadsheetId=local');
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    throw new Error('No data received from server');
                }
                
                status.innerHTML = `<div class="success">✅ Successfully loaded ${data.length} patient records</div>`;
                
                // Create dashboard cards
                const avgAge = calculateAverageAge(data);
                const paidCount = countPaidInvoices(data);
                const completedCount = countCompletedCases(data);
                
                cardsDiv.innerHTML = `
                    <div class="dashboard-cards">
                        <div class="card">
                            <h3>Active Patients</h3>
                            <div class="number">${data.length}</div>
                            <p>Currently active cases</p>
                        </div>
                        <div class="card">
                            <h3>Average Age</h3>
                            <div class="number">${avgAge}</div>
                            <p>Years old</p>
                        </div>
                        <div class="card">
                            <h3>Paid Invoices</h3>
                            <div class="number">${paidCount}</div>
                            <p>Out of ${data.length} total</p>
                        </div>
                        <div class="card">
                            <h3>Completed Cases</h3>
                            <div class="number">${completedCount}</div>
                            <p>CP completed</p>
                        </div>
                    </div>
                `;
                
                // Create patient table
                createPatientTable(data, tableDiv);
                
            } catch (error) {
                status.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
                cardsDiv.innerHTML = '';
                tableDiv.innerHTML = '';
            }
        }
        
        function createPatientTable(data, container) {
            const importantColumns = ['Patient Name', 'Age', 'City', 'CP Doctor', 'Hospice', 'PAID', 'Check list'];
            
            let html = '<h2>Active Patients</h2><table class="data-table"><thead><tr>';
            importantColumns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.forEach(patient => {
                html += '<tr>';
                importantColumns.forEach(col => {
                    let value = patient[col] || '-';
                    // Add some basic formatting
                    if (col === 'PAID' && value === 'yes') {
                        value = '✅ Yes';
                    } else if (col === 'PAID' && value === 'no') {
                        value = '❌ No';
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function calculateAverageAge(data) {
            const ages = data.filter(p => p.Age && !isNaN(p.Age)).map(p => parseInt(p.Age));
            return ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : 0;
        }
        
        function countPaidInvoices(data) {
            return data.filter(p => p.PAID && p.PAID.toLowerCase() === 'yes').length;
        }
        
        function countCompletedCases(data) {
            return data.filter(p => p['Check list'] && p['Check list'].toLowerCase() === 'complete').length;
        }
    </script>
</body>
</html> 